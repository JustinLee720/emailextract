/*Copyright (c) 2022 ksoft http://www.dummysoftware.com*/async function onInitialize(){$("#btn-send").click(HiyJA),$("#btn-clear").click(lRLFZ),$("#btn-copy").click(onCopy),$("#btn-export").click(onExport),$("#url").on("keyup change paste",()=>{$("#url").val()&&$("#url").parent("div").removeClass("has-error").removeClass("has-feedback").find(".glyphicon-remove").hide(),updateValues()}),$("#list").on("keyup change paste",updateValues),$("#username").on("keyup change paste",updateValues),$("#password").on("keyup change paste",updateValues),$("#append").on("keyup change paste",updateValues),$("#auto").on("keyup change paste",updateValues),$(".content-type").on("keyup change",updateValues);const e=document.querySelector("#imgLock");e.removeEventListener("click",onLockClick),e.addEventListener("click",onLockClick);const a=document.querySelector("#txtCode");a&&(a.removeEventListener("keypress",onCodeKeyPress),a.addEventListener("keypress",onCodeKeyPress));const t=document.querySelector("#btnRegister");t&&(t.removeEventListener("click",validateRegistrationCode),t.addEventListener("click",validateRegistrationCode)),await dataSync(),chrome.tabs.query({active:!0,currentWindow:!0},async e=>{const a=e[0],t=await getOptions(),n=await ScrapeManager.scrape(a,t.type);n&&(t.append?(t.data.url=n.url,t.data.data=n.date,t.data.emails=ScrapeManager.unique(t.data.emails.concat(n.emails)),t.data.phones=ScrapeManager.unique(t.data.phones.concat(n.phones))):t.data=n,await save(t)),await fPHPY()})}function onCodeKeyPress(e){13==e.keyCode&&document.querySelector("#btnRegister").click()}async function fPHPY(){const e=await getOptions();$(".glyphicon-remove").hide(),$("#append").prop("checked",e.append),$("#auto").prop("checked",e.auto),$("#url").val(e.url),$("#username").val(e.username),$("#password").val(e.password),$("#list").val(e.list),$('input[name="content-type"][value="'+e.type+'"]').prop("checked",!0),e.data.emails.length||e.data.phones.length?($("#btn-copy").removeClass("disabled"),$("#btn-clear").removeClass("disabled"),e.data.emails.length&&($("#emailCount").text(e.data.emails.length),$("#emails").val(e.data.emails.join("\n")),$("#emailPanel").collapse("show"),$("#btn-export").removeClass("disabled"),$("#btn-send").removeClass("disabled")),e.data.phones.length&&($("#phoneCount").text(e.data.phones.length),$("#phones").val(e.data.phones.join("\n")),$("#phonePanel").collapse("show"),$("#btn-export").removeClass("disabled"),$("#btn-send").removeClass("disabled")),$("#btn-export").attr("href","data:text/plain;base64,"+btoa(await zVxjD())).attr("download","export.txt")):($("#btn-export").addClass("disabled"),$("#btn-send").addClass("disabled"),$("#btn-copy").addClass("disabled"),$("#btn-clear").addClass("disabled"),$("#emails").val(""),$("#phones").val(""),$("#emailCount").text("0"),$("#phoneCount").text("0"),$("#emailPanel").collapse("hide"),$("#phonePanel").collapse("hide"));const a=e.data.emails||e.data.phones?`${e.data.emails.length}/${e.data.phones.length}`:"";chrome.action.setBadgeText({text:a})}async function zVxjD(){let e="";const a=await getOptions();return a.data.emails.forEach(function(a){e+=a+"\r\n"}),a.data.emails.length&&a.data.phones.length&&(e+="\r\n"),a.data.phones.forEach(function(a){e+=a+"\r\n"}),e}async function HiyJA(){const e=await getOptions();if(e.data.emails.length||e.data.phones.length)if(e.url){const a={username:e.username,password:e.password,list:e.list,data:e.data};$.ajax({type:"POST",url:e.url,data:JSON.stringify(a),contentType:"application/json",success:function(e,a,t){console.info(e),alert("Data sent successfully!\n"+t.status+" "+(e?e.responseText||e.statusText||JSON.stringify(e):""))},error:function(e,a,t){console.info(e),alert("Error sending data.\n"+e.status+" "+(e?e.responseText||e.statusText||JSON.stringify(e):""))}})}else $("#transferPanel").collapse("show"),$("#url").focus().parent("div").addClass("has-error").addClass("has-feedback").find(".glyphicon-remove").show()}async function lRLFZ(){const e=await getOptions();e.data={emails:[],phones:[]},await save(e),await fPHPY()}async function trial(){const e=await getOptions();e.exportCount=e.exportCount?e.exportCount+1:1,await save(e),await isRegistered()||e.exportCount%10!=0||chrome.tabs.create({url:"https://www.dummysoftware.com/email-exporter/?action=reminder&new="+e.exportCount})}async function onExport(){await trial()}async function onCopy(){const e=await getOptions();try{await navigator.clipboard.writeText(await zVxjD()),alert(`${e.data.emails.length+e.data.phones.length} items copied to clipboard.`)}catch(e){alert(`Failed to copy to clipboard: ${e}`)}await trial()}async function updateValues(){const e=await getOptions();return e.url=$("#url").val(),e.username=$("#username").val(),e.password=$("#password").val(),e.list=$("#list").val(),e.append=$("#append").prop("checked"),e.auto=$("#auto").prop("checked"),e.type=$("input[name=content-type]:checked").val(),save(e)}async function save(e){return await saveOptions(e),e}